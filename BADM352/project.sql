#tonywu, a----r-, -a-----2

CREATE TABLE PATIENTS(
	PATIENT_ID int NOT NULL UNIQUE,
    LASTNAME varchar(20),
    FIRSTNAME varchar(20),
    PHONE int,
    GENDER varchar(10),
    DOB date,

    PRIMARY KEY (PATIENT_ID)
);

CREATE TABLE PLAN(
	PLAN_ID int NOT NULL UNIQUE,
    PATIENT_ID int NOT NULL,
    PLAN_NAME varchar(20) NOT NULL,

    PRIMARY KEY(PLAN_ID),
    FOREIGN KEY(PATIENT_ID) REFERENCES PATIENTS (PATIENT_ID)
);

CREATE TABLE PLAN_LEVEL(
	LEVEL_ID int NOT NULL UNIQUE,
    LEVEL_NAME varchar(20) NOT NULL,

    PRIMARY KEY (LEVEL_ID)
);

CREATE TABLE PREMIUM(
	PLAN_ID int NOT NULL,
    LEVEL_ID int NOT NULL,
    PATIENT_ID int NOT NULL,
    PATIENT_PAY int NOT NULL,
    PLAN_PAY int NOT NULL,

    CONSTRAINT PK_PREMIUM PRIMARY KEY(
		PLAN_ID,
        LEVEL_ID
    ),

    FOREIGN KEY (PLAN_ID) REFERENCES PLAN (PLAN_ID),
    FOREIGN KEY (LEVEL_ID) REFERENCES PLAN_LEVEL (LEVEL_ID),
    FOREIGN KEY (PATIENT_ID) REFERENCES PATIENTS (PATIENT_ID)
);

CREATE TABLE PROVIDERS(
	PROVIDER_ID int NOT NULL UNIQUE,
    PROVIDER_NAME varchar(40) NOT NULL,
    PROVIDER_PHONE int NOT NULL,
    ADDRESS varchar(40) NOT NULL,

    PRIMARY KEY (PROVIDER_ID)
);

CREATE TABLE SERVICE(
	PATIENT_ID int NOT NULL UNIQUE,
    PROVIDER_ID int NOT NULL UNIQUE,
    TREATMENT varchar(100) NOT NULL,

	CONSTRAINT PK_SERVICE PRIMARY KEY(
		PATIENT_ID,
        PROVIDER_ID
    ),

    FOREIGN KEY (PATIENT_ID) REFERENCES PATIENTS (PATIENT_ID),
    FOREIGN KEY (PROVIDER_ID) REFERENCES PROVIDERS (PROVIDER_ID)
 );

 CREATE TABLE CLAIM(
	CLAIM_ID int NOT NULL UNIQUE,
    PROVIDER_ID int NOT NULL,
    PATIENT_ID int NOT NULL,
    DATE_RECEIVED date NOT NULL,
    AMOUNT_CLAIMED int NOT NULL,
    AMOUNT_PAID int NOT NULL,
    CLAIM_STATUS varchar(20),
    DATE_FINISHED date,

    PRIMARY KEY (CLAIM_ID),

	FOREIGN KEY (PROVIDER_ID) REFERENCES PROVIDERS (PROVIDER_ID),
    FOREIGN KEY (PATIENT_ID) REFERENCES PATIENTS (PATIENT_ID)
);

#Insert data into tables
#PATIENTS
INSERT INTO PATIENTS VALUES(1, 'Michaels', 'Brandon', 5124487, 'M', '1995-01-27');
INSERT INTO PATIENTS VALUES(2, 'Smith', 'Megan', 1425993, 'F', '1990-12-15');
INSERT INTO PATIENTS VALUES(3, 'Jones', 'James', 2175880, 'M', '1993-04-04');
INSERT INTO PATIENTS VALUES(4, 'Williams', 'April', 8014512, 'F', '1994-06-01');
INSERT INTO PATIENTS VALUES(5, 'Granger', 'Chelsea', 6182424, 'F', '1991-07-11');

#PLAN
INSERT INTO PLAN VALUES(1101, 1, 'Preferred');
INSERT INTO PLAN VALUES(1102, 2, 'Precision');
INSERT INTO PLAN VALUES(1103, 3, 'Direct');

#PLAN_LEVEL
INSERT INTO PLAN_LEVEL VALUES(101, 'Bronze');
INSERT INTO PLAN_LEVEL VALUES(102, 'Silver');
INSERT INTO PLAN_LEVEL VALUES(103, 'Gold');
INSERT INTO PLAN_LEVEL VALUES(104, 'Platinum');

#PREMIUM
INSERT INTO PREMIUM VALUES(1101, 101, 1, 800, 1200);
INSERT INTO PREMIUM VALUES(1102, 102, 2, 600, 1400);
INSERT INTO PREMIUM VALUES(1103, 103, 3, 400, 1600);
INSERT INTO PREMIUM VALUES(1103, 104, 4, 200, 1800);

#PROVIDERS
INSERT INTO PROVIDERS VALUES(10, 'Advocate', 6309851, '1900 Sequoia Ave, Aurora, IL');
INSERT INTO PROVIDERS VALUES(11, 'UnitedHealth', 7084444, '10 E Main Street, Schaumburg, IL');
INSERT INTO PROVIDERS VALUES(12, 'DuPage Medical', 6305551, '14250 Ogden Ave, Naperville, IL');
INSERT INTO PROVIDERS VALUES(13, 'Aetna', 7088080, '54123 State Street, Chicago, IL');

#SERVICE
INSERT INTO SERVICE VALUES(1, 10, 'Annual Physical');
INSERT INTO SERVICE VALUES(2, 11, 'Bronchitis treatment');
INSERT INTO SERVICE VALUES(3, 12, 'Strep throat treatment');
INSERT INTO SERVICE VALUES(4, 13, 'Allergy treatment');

#CLAIMS
INSERT INTO CLAIM VALUES(1234, 10, 1, '2014-02-02', 500, 500, 0, '2014-05-30');
INSERT INTO CLAIM VALUES(1417, 11, 2, '2015-10-10', 2500, 2250, 0, '2016-03-03');
INSERT INTO CLAIM VALUES(2552, 12, 3, '2014-09-15', 750, 750, 0, '2014-11-22');
INSERT INTO CLAIM VALUES(3456, 13, 4, '2016-05-31', 1000, 900, 0, '2016-08-01');


#Queries
#1.      Retrieve the information of all patients who have received treatment and the treatment type.
SELECT * FROM PATIENTS INNER JOIN SERVICE ON PATIENTS.PATIENT_ID=SERVICE.PATIENT_ID;
#2.      Whatâ€™s the average price of a plan?
SELECT AVG(PLAN_PAY) FROM PREMIUM;
#3.      Return the patients who have a plan.
SELECT FIRSTNAME, LASTNAME FROM PATIENTS RIGHT JOIN PREMIUM ON PATIENTS.PATIENT_ID = PREMIUM.PATIENT_ID;# MIN(PLAN.PATIENT_ID) AND MAX(PLAN.PATIENT_ID);
#4.      Which patients still owe money on claims?
SELECT * FROM CLAIM WHERE AMOUNT_CLAIMED-AMOUNT_PAID > 0;
#5.      How many male and female patients are there?
SELECT GENDER, COUNT(*) FROM PATIENTS GROUP BY GENDER;
#6.      List all information on patients and their plans.
SELECT * FROM PATIENTS INNER JOIN PREMIUM ON PATIENTS.PATIENT_ID=PREMIUM.PATIENT_ID;
#7.      How many claims were received each year?
SELECT YEAR(DATE_RECEIVED), COUNT(DATE_RECEIVED) FROM CLAIM GROUP BY YEAR(DATE_RECEIVED);
#8.      Which patient has the highest plan cost?
SELECT FIRSTNAME, LASTNAME, PATIENT_PAY FROM PATIENTS INNER JOIN PREMIUM ON PATIENTS.PATIENT_ID = PREMIUM.PATIENT_ID HAVING PATIENT_PAY = MAX(PATIENT_PAY);
#9.      Compute the age of all the patients.
SELECT FIRSTNAME, LASTNAME, DOB, TIMESTAMPDIFF(YEAR, DOB, CURRENT_DATE()) FROM PATIENTS;
#10.   How much money has UnitedHealth received from patients?
SELECT SUM(AMOUNT_PAID) FROM CLAIM WHERE PROVIDER_ID=(SELECT PROVIDER_ID FROM PROVIDERS WHERE PROVIDER_NAME='UnitedHealth');
